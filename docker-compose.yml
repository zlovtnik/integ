version: '3.8'

services:
  # ===========================================================================
  # GprintEx Application
  # ===========================================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: gprint_ex
    ports:
      - "${PORT:-4000}:4000"
    environment:
      - MIX_ENV=prod
      - PHX_SERVER=true
      - PORT=4000
      - SECRET_KEY_BASE=${SECRET_KEY_BASE}
      # Oracle ADB Configuration
      - ORACLE_HOST=${ORACLE_HOST}
      - ORACLE_PORT=${ORACLE_PORT:-1522}
      - ORACLE_DATABASE=${ORACLE_DATABASE}
      - ORACLE_USER=${ORACLE_USER}
      - ORACLE_PASSWORD=${ORACLE_PASSWORD}
      - TNS_ADMIN=/home/app/wallet
      - ORACLE_POOL_SIZE=${ORACLE_POOL_SIZE:-10}
      # Keycloak Configuration  
      - KEYCLOAK_URL=${KEYCLOAK_URL}
      - KEYCLOAK_REALM=${KEYCLOAK_REALM}
      - KEYCLOAK_CLIENT_ID=${KEYCLOAK_CLIENT_ID}
      - KEYCLOAK_CLIENT_SECRET=${KEYCLOAK_CLIENT_SECRET}
      - JWT_SECRET=${JWT_SECRET}
    volumes:
      - ./wallet:/home/app/wallet:ro
    depends_on:
      keycloak:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - gprint_network
    restart: unless-stopped

  # ===========================================================================
  # Keycloak
  # ===========================================================================
  # SECURITY NOTE:
  # - For production: Set KEYCLOAK_MODE=start and provide the following required variables:
  #     - KEYCLOAK_MODE=start
  #     - KC_HOSTNAME (required for production TLS)
  #     - KC_HTTPS_CERTIFICATE_FILE (required for production TLS)
  #     - KC_HTTPS_CERTIFICATE_KEY_FILE (required for production TLS)
  #   Provide TLS certs via volumes and set KEYCLOAK_ADMIN_PASSWORD via secrets
  # - For development only: KEYCLOAK_MODE defaults to start-dev mode (no TLS required)
  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: gprint_keycloak
    entrypoint: /opt/keycloak/entrypoint.sh
    command: ${KEYCLOAK_MODE:-start-dev}
    ports:
      - "${KEYCLOAK_PORT:-8080}:8080"
      - "${KEYCLOAK_HTTPS_PORT:-8443}:8443"
    environment:
      - KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN:-admin}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD:?KEYCLOAK_ADMIN_PASSWORD must be set}
      - KC_DB=postgres
      - KC_DB_URL=jdbc:postgresql://keycloak_db:5432/keycloak
      - KC_DB_USERNAME=keycloak
      - KC_DB_PASSWORD=${KEYCLOAK_DB_PASSWORD:-keycloak}
      # Production TLS settings (required when KEYCLOAK_MODE=start)
      # Use :- syntax to allow empty values for dev mode (start-dev doesn't need TLS)
      - KC_HOSTNAME=${KC_HOSTNAME:-}
      - KC_HTTPS_CERTIFICATE_FILE=${KC_HTTPS_CERTIFICATE_FILE:-}
      - KC_HTTPS_CERTIFICATE_KEY_FILE=${KC_HTTPS_CERTIFICATE_KEY_FILE:-}
    volumes:
      - ${KEYCLOAK_TLS_CERTS_PATH:-./certs}:/opt/keycloak/certs:ro
      - ./keycloak-entrypoint.sh:/opt/keycloak/entrypoint.sh:ro
    depends_on:
      keycloak_db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - gprint_network
    restart: unless-stopped

  # ===========================================================================
  # PostgreSQL for Keycloak
  # ===========================================================================
  keycloak_db:
    image: postgres:15-alpine
    container_name: gprint_keycloak_db
    environment:
      - POSTGRES_USER=keycloak
      - POSTGRES_PASSWORD=${KEYCLOAK_DB_PASSWORD:-keycloak}
      - POSTGRES_DB=keycloak
    volumes:
      - keycloak_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - gprint_network

networks:
  gprint_network:
    driver: bridge

volumes:
  keycloak_data:
